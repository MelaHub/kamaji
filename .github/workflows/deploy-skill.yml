name: Alexa-hosted deploy

on:
  push:
    branches: ["main"]
    tags: ["v*"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install ASK CLI
        run: npm i -g ask-cli@2

      - name: Configure ASK CLI (non-interactive)
        run: |
          mkdir -p ~/.ask
          cat > ~/.ask/cli_config <<'JSON'
          {
            "profiles": {
              "default": {
                "token": {
                  "refresh_token": "${{ secrets.LWA_REFRESH_TOKEN }}"
                },
                "oauth": {
                  "client_id": "${{ secrets.LWA_CLIENT_ID }}",
                  "client_secret": "${{ secrets.LWA_CLIENT_SECRET }}"
                },
                "vendor_id": "${{ secrets.ASK_VENDOR_ID }}"
              }
            }
          }
          JSON

      - name: Get Alexa-hosted repo URL
        id: repo
        run: |
          ask smapi get-alexa-hosted-skill-metadata -s ${{ secrets.ALEXA_SKILL_ID }} > meta.json
          REPO_URL=$(jq -r '.alexaHosted.repository.url' meta.json)

          echo "Repo URL (no creds): $REPO_URL"
          echo "url=$REPO_URL" >> $GITHUB_OUTPUT

          set -euo pipefail

      - name: Generate temporary git credentials
        id: creds
        run: |
          ask smapi generate-credentials-for-alexa-hosted-skill \
            -s ${{ secrets.ALEXA_SKILL_ID }} \
            --repository-type GIT \
            --repository-url "${{ steps.repo.outputs.url }}" > creds.json 

          USER=$(jq -r '.repositoryCredentials.username' creds.json)
          PASS=$(jq -r '.repositoryCredentials.password' creds.json)

          test -n "$USER"
          test -n "$PASS"

          # mask in logs
          echo "::add-mask::$USER"
          echo "::add-mask::$PASS"

          echo "user=$USER" >> $GITHUB_OUTPUT
          echo "pass=$PASS" >> $GITHUB_OUTPUT



      - name: Push to Alexa-hosted branch
        run: |
          set -euo pipefail
          export REPO_URL="${{ steps.repo.outputs.url }}"
          export GIT_USERNAME="${{ steps.creds.outputs.user }}"
          export GIT_PASSWORD="${{ steps.creds.outputs.pass }}"

          # 3) URL-encode user/pass and build authed url
          AUTHED_URL="$(python3 - <<'PY'
          import os, urllib.parse
          repo = os.environ["REPO_URL"]
          u = urllib.parse.quote(os.environ["GIT_USERNAME"], safe="")
          p = urllib.parse.quote(os.environ["GIT_PASSWORD"], safe="")
          print(repo.replace("https://", f"https://{u}:{p}@", 1))
          PY
          )"
          # Optional: safe print (masked)
          echo "$AUTHED_URL" | sed 's#https://.*@#https://***:***@#'

          # 4) Decide target branch
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TARGET_BRANCH="prod"
          else
            TARGET_BRANCH="master"
          fi

          # 5) Push
          git push "$AUTHED_URL" HEAD:"$TARGET_BRANCH" --force
