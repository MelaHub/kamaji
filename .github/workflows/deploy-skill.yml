name: Alexa-hosted deploy

on:
  push:
    branches: ["main"]
    tags: ["v*"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install ASK CLI
        run: npm i -g ask-cli@2

      - name: Configure ASK CLI (non-interactive)
        run: |
          mkdir -p ~/.ask
          cat > ~/.ask/cli_config <<'JSON'
          {
            "profiles": {
              "default": {
                "token": {
                  "refresh_token": "${{ secrets.LWA_REFRESH_TOKEN }}"
                },
                "oauth": {
                  "client_id": "${{ secrets.LWA_CLIENT_ID }}",
                  "client_secret": "${{ secrets.LWA_CLIENT_SECRET }}"
                },
                "vendor_id": "${{ secrets.ASK_VENDOR_ID }}"
              }
            }
          }
          JSON

      - name: Get Alexa-hosted repo URL
        id: repo
        run: |
          ask smapi get-alexa-hosted-skill-metadata -s ${{ secrets.ALEXA_SKILL_ID }} > meta.json
          REPO_URL=$(node -p "require('./meta.json').alexaHosted.repository.url")
          echo "url=$REPO_URL" >> $GITHUB_OUTPUT

      - name: Generate temporary git credentials
        id: creds
        run: |
          ask smapi generate-credentials-for-alexa-hosted-skill \
            -s ${{ secrets.ALEXA_SKILL_ID }} \
            --repository-type GIT > creds.json

          USER=$(node -p "require('./creds.json').repositoryCredentials.username")
          PASS=$(node -p "require('./creds.json').repositoryCredentials.password")

          # mask in logs
          echo "::add-mask::$USER"
          echo "::add-mask::$PASS"

          echo "user=$USER" >> $GITHUB_OUTPUT
          echo "pass=$PASS" >> $GITHUB_OUTPUT

      - name: Push to Alexa-hosted branch
        run: |
          set -euo pipefail
          REPO_URL="${{ steps.repo.outputs.url }}"
          USER="${{ steps.creds.outputs.user }}"
          PASS="${{ steps.creds.outputs.pass }}"

          # Decide target branch
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TARGET_BRANCH="prod"
          else
            TARGET_BRANCH="master"
          fi

          git config user.email "github-actions@users.noreply.github.com"
          git config user.name "github-actions"

          AUTHED_URL="https://${USER}:${PASS}@${REPO_URL#https://}"
          git remote remove alexa 2>/dev/null || true
          git remote add alexa "$AUTHED_URL"

          echo "Pushing ${GITHUB_SHA} -> ${TARGET_BRANCH}"
          git push alexa HEAD:"${TARGET_BRANCH}" --force
